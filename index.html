<!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>CaughtMyEye - Take a Picture</title>
     <title>CaughtMyEye - Mobile Capture</title>
     <!-- Tailwind via CDN for quick styling -->
     <script src="https://cdn.tailwindcss.com"></script>
     <style>
         * { margin: 0; padding: 0; box-sizing: border-box; }
         body { 
             font-family: Arial, sans-serif; 
             text-align: center; 
             background-color: #f4f4f4; 
             color: #333;
         /* Custom styles to complement Tailwind */
         #video, #canvas {
             width: 100%;
             max-width: 400px;
             border-radius: 0.5rem;
             border: 2px solid #3b82f6;
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
             background: #000;
         }
 
         /* Top Bar */
         .top-bar {
             width: 100%;
             background-color: #007BFF;
             color: white;
             padding: 15px 0;
             font-size: 24px;
             font-weight: bold;
             text-align: center;
             position: fixed;
             top: 0;
             left: 0;
             z-index: 1000;
         #canvas {
             display: none;
             margin-top: 1rem;
         }
 
         .container {
             margin-top: 80px;
             padding: 20px;
         
         .section {
             display: none;
             padding: 1.5rem;
         }
 
         video, canvas {
             width: 100%;
             max-width: 400px;
             border-radius: 8px;
             border: 2px solid #007BFF;
             box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
             margin: 10px 0;
         
         .section.active {
             display: block;
         }
 
         button, input {
             background-color: #007BFF;
         
         .btn {
             padding: 0.75rem 1.5rem;
             border-radius: 0.375rem;
             font-weight: 600;
             transition: all 0.2s;
             margin: 0.5rem;
         }
         
         .btn-primary {
             background-color: #3b82f6;
             color: white;
             border: none;
             padding: 12px 24px;
             font-size: 18px;
             border-radius: 5px;
             cursor: pointer;
             transition: background 0.3s;
             margin: 10px;
         }
 
         input {
             background-color: white;
             color: #333;
             border: 1px solid #007BFF;
             text-align: center;
         
         .btn-primary:hover {
             background-color: #2563eb;
         }
 
         button:hover {
             background-color: #0056b3;
         
         .btn-secondary {
             background-color: #e5e7eb;
             color: #374151;
         }
 
         #pairing-section, #camera-section {
             display: none;
         
         .btn-secondary:hover {
             background-color: #d1d5db;
         }
 
         #pairing-section.active, #camera-section.active {
             display: block;
         
         .btn-success {
             background-color: #10b981;
             color: white;
         }
 
         #status {
             margin: 15px 0;
             padding: 10px;
             border-radius: 5px;
         
         .btn-success:hover {
             background-color: #059669;
         }
 
         .success {
             background-color: #d4edda;
             color: #155724;
         
         .status {
             padding: 0.75rem;
             border-radius: 0.375rem;
             margin: 1rem 0;
         }
 
         .error {
             background-color: #f8d7da;
             color: #721c24;
         
         .status-success {
             background-color: #d1fae5;
             color: #065f46;
         }
         
         .status-error {
             background-color: #fee2e2;
             color: #b91c1c;
         }
 
         #camera-section {
           position: relative;
           overflow: hidden;
           background: black; /* Shows while camera loads */
         .completion-message {
             text-align: center;
             padding: 2rem;
             color: #1f2937;
         }
         
         .code-input {
             width: 100%;
             max-width: 300px;
             padding: 0.75rem;
             border: 2px solid #3b82f6;
             border-radius: 0.375rem;
             font-size: 1.25rem;
             text-align: center;
             margin: 1rem auto;
             display: block;
         }
     </style>
     <!-- Firebase SDK -->
     <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
     <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
     <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
 </head>
 <body>
     <div class="top-bar">CaughtMyEye</div>
 <body class="bg-gray-100 min-h-screen">
     <div class="bg-blue-500 text-white p-4 text-center text-xl font-bold sticky top-0 z-50 shadow-md">
         CaughtMyEye
     </div>
 
     <div class="container">
         <div id="pairing-section" class="active">
             <h2>Pair Device</h2>
             <input type="text" id="pairing-code" placeholder="Enter 6-digit code" maxlength="6">
             <button id="pair-button">Pair Device</button>
             <div id="status"></div>
     <div class="container mx-auto p-4 pt-20">
         <!-- Pairing Section -->
         <div id="pairing-section" class="section active bg-white rounded-xl shadow-md p-6 max-w-md mx-auto">
             <h2 class="text-xl font-semibold mb-4 text-center">ðŸ”— Pair Device</h2>
             <p class="text-gray-600 mb-4 text-center">Enter the 6-digit code from your dashboard</p>
             
             <input type="text" id="pairing-code" placeholder="Enter code" maxlength="6" 
                    class="code-input uppercase font-mono tracking-widest">
             
             <div class="flex justify-center">
                 <button id="pair-button" class="btn btn-primary">
                     Pair Device
                 </button>
             </div>
             
             <div id="status" class="status"></div>
         </div>
 
         <div id="camera-section">
             <h2>Take a Picture</h2>
             <video id="video" autoplay playsinline webkit-playsinline></video>
             <button id="capture">ðŸ“¸ Capture</button>
             <canvas id="canvas"></canvas>
             <div id="status"></div>
         <!-- Camera Section -->
         <div id="camera-section" class="section bg-white rounded-xl shadow-md p-6 max-w-md mx-auto">
             <h2 class="text-xl font-semibold mb-4 text-center">ðŸ“· Capture Landmark</h2>
             
             <div class="relative">
                 <video id="video" autoplay playsinline></video>
                 <canvas id="canvas"></canvas>
             </div>
             
             <div class="flex flex-wrap justify-center mt-4">
                 <button id="capture" class="btn btn-primary">
                     ðŸ“¸ Capture
                 </button>
                 <button id="retake" class="btn btn-secondary hidden">
                     ðŸ”„ Retake
                 </button>
                 <button id="use" class="btn btn-success hidden">
                     âœ… Use This
                 </button>
             </div>
             
             <div id="camera-status" class="status"></div>
         </div>
         
         <!-- Completion Section -->
         <div id="completion-section" class="section bg-white rounded-xl shadow-md p-6 max-w-md mx-auto">
             <div class="completion-message">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                 </svg>
                 <h2 class="text-2xl font-bold text-green-600 mb-2">Photo Uploaded!</h2>
                 <p class="text-gray-600 mb-4">Your image has been sent to the dashboard</p>
                 <p class="text-sm text-gray-500">You may now close this window</p>
             </div>
         </div>
     </div>
 
   // DOM elements
   const pairingSection = document.getElementById('pairing-section');
   const cameraSection = document.getElementById('camera-section');
   const completionSection = document.getElementById('completion-section');
   const pairButton = document.getElementById('pair-button');
   const pairingCodeInput = document.getElementById('pairing-code');
   const statusDiv = document.getElementById('status');
   const cameraStatusDiv = document.getElementById('camera-status');
   const video = document.getElementById('video');
   const canvas = document.getElementById('canvas');
   const captureButton = document.getElementById('capture');
   const captureBtn = document.getElementById('capture');
   const retakeBtn = document.getElementById('retake');
   const useBtn = document.getElementById('use');
   
   let pairedUserId = null;
   let currentPhotoRef = null;
   let stream = null;
 
   // Pairing logic
   pairButton.addEventListener('click', async () => {
     const code = pairingCodeInput.value.trim().toUpperCase();
     console.log("Attempting to pair with code:", code); // Debug
 
     if (!code || code.length !== 6) {
         showStatus('Please enter a valid 6-digit code', 'error');
 @@ -162,63 +210,46 @@
 
         const docRef = db.collection('pairingCodes').doc(code);
         const docSnap = await docRef.get();
         console.log("Firestore response:", docSnap.exists, docSnap.data()); // Debug
 
         if (!docSnap.exists) {
             throw new Error('Invalid pairing code - please generate a new one');
         }
 
         const data = docSnap.data();
         console.log("Retrieved code data:", data); // Debug
 
         if (data.status !== 'pending') {
             throw new Error('This code was already used or expired');
         }
 
         console.log("Attempting to update document..."); // Debug
         await docRef.update({
             status: 'completed',
             pairedAt: firebase.firestore.FieldValue.serverTimestamp(),
             pairedUserId: data.userId
         });
 
         pairedUserId = data.userId;
         console.log("Pairing successful, user ID:", pairedUserId); // Debug
         showStatus('Paired successfully! Loading camera...', 'success');
 
         // Add 1-second delay for UI feedback
         // Transition to camera view
         setTimeout(() => {
             pairingSection.classList.remove('active');
             cameraSection.classList.add('active');
             initializeCamera();
         }, 1000);
 
     } catch (error) {
         console.error('Full pairing error:', error); // Detailed error
         console.error('Pairing error:', error);
         showStatus('Pairing failed: ' + error.message, 'error');
     }
 });
 
 // Add this check before camera init
 async function checkPermissions() {
   try {
     const permissionStatus = await navigator.permissions.query({ name: 'camera' });
     if (permissionStatus.state === 'denied') {
       showStatus('Please enable camera permissions in browser settings', 'error');
       return false;
     }
     return true;
   } catch (e) {
     return true; // Proceed if Permission API not available
   }
 }
   });
 
   // Camera logic
     function initializeCamera() {
       if (stream) {
         stream.getTracks().forEach(track => track.stop());
       }
   async function initializeCamera() {
     if (stream) {
       stream.getTracks().forEach(track => track.stop());
     }
 
     try {
       const constraints = {
         video: {
           facingMode: "environment",
 @@ -227,105 +258,118 @@
         },
         audio: false
       };
     
       navigator.mediaDevices.getUserMedia(constraints)
         .then(s => {
           stream = s;
           video.srcObject = stream;
           video.setAttribute('playsinline', '');
           video.setAttribute('webkit-playsinline', '');
           return video.play();
         })
         .catch(err => {
           console.error("Camera Error:", err);
           showStatus('Camera error: ' + err.message, 'error');
         });
       
       stream = await navigator.mediaDevices.getUserMedia(constraints);
       video.srcObject = stream;
       
       // Set up button handlers
       captureBtn.addEventListener('click', capturePhoto);
       retakeBtn.addEventListener('click', retakePhoto);
       useBtn.addEventListener('click', uploadAndFinish);
       
     } catch (err) {
       console.error("Camera Error:", err);
       showCameraStatus('Camera error: ' + err.message, 'error');
     }
   }
 
     async function capturePhoto() {
       try {
         canvas.width = video.videoWidth;
         canvas.height = video.videoHeight;
         const ctx = canvas.getContext('2d');
         
         // Draw image without mirroring
         ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
         
         // Show canvas preview
         canvas.style.display = 'block';
         
         captureButton.textContent = 'ðŸ”„ Retake';
         captureButton.onclick = retakePhoto;
         
         if (!document.getElementById('use-button')) {
           const useBtn = document.createElement('button');
           useBtn.id = 'use-button';
           useBtn.textContent = 'âœ… Use This';
           useBtn.className = 'bg-green-500 text-white py-2 px-4 rounded-lg mx-2';
           useBtn.onclick = uploadAndFinish;
           captureButton.after(useBtn);
         }
       } catch (err) {
         showStatus('Capture failed: ' + err.message, 'error');
       }
   function capturePhoto() {
     try {
       // Set canvas dimensions to match video
       canvas.width = video.videoWidth;
       canvas.height = video.videoHeight;
       
       // Draw image without mirroring
       const ctx = canvas.getContext('2d');
       ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
       
       // Show canvas and buttons
       canvas.style.display = 'block';
       captureBtn.classList.add('hidden');
       retakeBtn.classList.remove('hidden');
       useBtn.classList.remove('hidden');
       
       // Pause the video stream
       stream.getTracks().forEach(track => track.stop());
       
     } catch (err) {
       showCameraStatus('Capture failed: ' + err.message, 'error');
     }
   }
 
   function retakePhoto() {
     // Clear canvas
     const ctx = canvas.getContext('2d');
     ctx.clearRect(0, 0, canvas.width, canvas.height);
     canvas.style.display = 'none';
 
     // Reset buttons
     captureButton.textContent = 'ðŸ“¸ Capture';
     captureButton.onclick = capturePhoto;
     document.getElementById('use-button')?.remove();
     captureBtn.classList.remove('hidden');
     retakeBtn.classList.add('hidden');
     useBtn.classList.add('hidden');
     
     // Restart camera
     initializeCamera();
   }
 
 async function uploadAndFinish() {
   try {
     showStatus('Saving your photo...', '');
     
     const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
     const photoName = `${pairedUserId}/${Date.now()}.jpg`;
     const photoRef = storage.ref().child(photoName);
     
     const uploadTask = photoRef.put(blob);
     
     uploadTask.on('state_changed',
       null,
       error => showStatus('Upload failed: ' + error.message, 'error'),
       async () => {
         const url = await uploadTask.snapshot.ref.getDownloadURL();
         await db.collection('userPhotos').add({
           userId: pairedUserId,
           url: url,
           timestamp: firebase.firestore.FieldValue.serverTimestamp()
         });
         
         // Clean up
         stream.getTracks().forEach(track => track.stop());
         
         // Show completion message
         cameraSection.innerHTML = `
           <div class="completion-message">
             <h2 style="color: #155724; font-size: 1.5rem; margin-bottom: 1rem;">
               âœ“ Photo Successfully Uploaded!
             </h2>
             <p>Your image has been sent to the Dashboard</p>
             <p style="color: #666; margin-top: 1rem;">You may now close this window</p>
           </div>
         `;
       }
     );
   } catch (err) {
     showStatus('Error: ' + err.message, 'error');
   async function uploadAndFinish() {
     try {
       showCameraStatus('Saving your photo...', '');
       
       // Convert canvas to blob
       const blob = await new Promise(resolve => {
         canvas.toBlob(resolve, 'image/jpeg', 0.9);
       });
       
       // Create unique filename
       const photoName = `user_photos/${pairedUserId}/${Date.now()}.jpg`;
       const photoRef = storage.ref().child(photoName);
       
       // Upload to Firebase Storage
       const uploadTask = photoRef.put(blob);
       
       uploadTask.on('state_changed',
         null,
         error => {
           showCameraStatus('Upload failed: ' + error.message, 'error');
           retakePhoto(); // Allow user to try again
         },
         async () => {
           // Get download URL
           const url = await uploadTask.snapshot.ref.getDownloadURL();
           
           // Save to Firestore
           await db.collection('userPhotos').add({
             userId: pairedUserId,
             url: url,
             timestamp: firebase.firestore.FieldValue.serverTimestamp(),
             orientation: window.screen.orientation.type
           });
           
           // Show completion screen
           cameraSection.classList.remove('active');
           completionSection.classList.add('active');
         }
       );
     } catch (err) {
       showCameraStatus('Error: ' + err.message, 'error');
       console.error('Upload error:', err);
     }
   }
 }
 
   // Helper functions
   function showStatus(message, type) {
     statusDiv.textContent = message;
     statusDiv.className = type ? type : '';
     statusDiv.className = `status ${type ? 'status-' + type : ''}`;
   }
   
   function showCameraStatus(message, type) {
     cameraStatusDiv.textContent = message;
     cameraStatusDiv.className = `status ${type ? 'status-' + type : ''}`;
   }
   
   // Auto-focus the input field
   pairingCodeInput.focus();
 </script>
 </body>
 </html>
